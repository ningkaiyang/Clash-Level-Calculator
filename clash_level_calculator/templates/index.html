<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Clash Level Calculator</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800;900&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>
<body>
  <main class="page">
    <header class="hero">
      <div>
        <p class="eyebrow">Clash Royale Â· Level 16 Update</p>
        <h1>Level-up planner, now on the web. <span aria-hidden="true">ðŸ‘‘</span></h1>
        <p class="lede">Choose your optimization mode below: minimize resources to reach your next king level, or maximize XP from your current resources.</p>
      </div>
      <div class="pill">Powered by Flask Â· Render-ready Â· Built by <b>ningkaiyang</b> (Discord, GitHub, CR)</div>
    </header>

    {% if errors %}
    <section class="panel error">
      <h2>Something went wrong</h2>
      <ul>
        {% for error in errors %}
          <li>{{ error }}</li>
        {% endfor %}
      </ul>
    </section>
    {% endif %}

    <section class="panel">
      <!-- Mode Tabs -->
      <div class="mode-tabs">
        <button type="button" class="mode-tab {% if mode == 'min_cost' %}active{% endif %}" data-mode="min_cost">
          <span class="tab-icon">ðŸ’°</span>
          <span class="tab-label">Min Cost to Next King</span>
        </button>
        <button type="button" class="mode-tab {% if mode == 'max_xp' %}active{% endif %}" data-mode="max_xp">
          <span class="tab-icon">âœ¨</span>
          <span class="tab-label">Max XP from Resources</span>
        </button>
      </div>

      <!-- Mode Descriptions -->
      <div class="mode-description" id="desc-min_cost" {% if mode != 'min_cost' %}style="display: none;"{% endif %}>
        <div class="how-to-use">
          <h3>ðŸ“‹ How to use:</h3>
          <p>Use this when you need to figure out the <strong>minimum efficient amount of resources</strong> you need to get to the next king level and the upgrade path. Perfect when you're planning ahead and want to know the cheapest route to unlock the next King Tower ability.</p>
        </div>
      </div>
      <div class="mode-description" id="desc-max_xp" {% if mode != 'max_xp' %}style="display: none;"{% endif %}>
        <div class="how-to-use">
          <h3>ðŸ“‹ How to use:</h3>
          <p>Use this when your deck is maxed, and you now need to figure out how you can <strong>farm the most amount of XP</strong> from your current resources to get as far into the next king levels as possible. Ideal for players who want to spend everything efficiently.</p>
        </div>
      </div>

      <form method="POST" class="form-grid">
        <input type="hidden" name="mode" id="mode-input" value="{{ mode }}">
        
        <div class="card">
          <div class="card-header">
            <h2>Fetch player snapshot</h2>
            <p class="hint">RoyaleAPI lookup requires <code>ROYALE_API_KEY</code> set on the server.</p>
          </div>
          <label class="field">
            <span>Player tag</span>
            <input type="text" name="player_tag" placeholder="#G2VV9802" value="{{ player_tag }}" autocomplete="off">
          </label>
          <div class="field-row">
            <label class="field">
              <span>Available gold</span>
              <input type="text" name="gold" placeholder="450000" value="{{ gold_input }}">
            </label>
            <label class="field">
              <span>Available gems</span>
              <input type="text" name="gems" placeholder="800" value="{{ gems_input }}">
            </label>
          </div>
          
          <!-- Target Level (only for min cost mode) -->
          <div class="target-level-section" id="target-level-section" {% if mode != 'min_cost' %}style="display: none;"{% endif %}>
            <label class="field">
              <span>Target King Level (optional)</span>
              <input type="text" name="target_level" placeholder="Next level" value="{{ target_level_input }}">
              <span class="field-hint">Leave blank for next level. Important milestones: {{ important_king_levels | join(', ') }}</span>
            </label>
          </div>
          
          <div class="wild-grid">
            <label class="field-label">Wild Cards</label>
            <div class="wild-grid__inputs">
              <label class="field">
                <span>Common</span>
                <input type="text" name="wild_common" placeholder="0" value="{{ wild_cards_input.common }}">
              </label>
              <label class="field">
                <span>Rare</span>
                <input type="text" name="wild_rare" placeholder="0" value="{{ wild_cards_input.rare }}">
              </label>
              <label class="field">
                <span>Epic</span>
                <input type="text" name="wild_epic" placeholder="0" value="{{ wild_cards_input.epic }}">
              </label>
              <label class="field">
                <span>Legendary</span>
                <input type="text" name="wild_legendary" placeholder="0" value="{{ wild_cards_input.legendary }}">
              </label>
              <label class="field">
                <span>Champion</span>
                <input type="text" name="wild_champion" placeholder="0" value="{{ wild_cards_input.champion }}">
              </label>
            </div>
          </div>
          <div class="actions">
            <button type="submit" class="btn-clash" id="submit-btn">
              <span id="btn-text-min_cost" {% if mode != 'min_cost' %}style="display: none;"{% endif %}>Calculate minimum cost</span>
              <span id="btn-text-max_xp" {% if mode != 'max_xp' %}style="display: none;"{% endif %}>Fetch + optimize XP</span>
            </button>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <h2>Optimizer settings</h2>
            <p class="hint">Toggle how aggressive the plan should be.</p>
          </div>
          <label class="checkbox">
            <input type="checkbox" name="use_gems" {% if settings.use_gems %}checked{% endif %}>
            <span>Allow spending gems for missing cards</span>
          </label>
          <label class="checkbox">
            <input type="checkbox" name="infinite_gold" {% if settings.infinite_gold %}checked{% endif %}>
            <span>Ignore gold limits (card bottleneck mode)</span>
          </label>
          
          {% if player_data %}
          <div class="player-info">
            <p class="player-info-label">Current Status</p>
            <p class="player-info-value">King Level {{ player_data.profile.king_level }} (+{{ "{:,}".format(player_data.profile.xp_into_level) }} XP)</p>
          </div>
          {% endif %}
        </div>
      </form>
    </section>

    {% if result %}
    <section class="panel results">
      <header class="results-header">
        <div>
          <h2>Plan summary</h2>
          <p class="hint">
            {% if mode == 'min_cost' %}
            Minimum cost path to reach King Level {{ result.final_profile.king_level }}.
            {% else %}
            Maximum XP optimization based on your current resources.
            {% endif %}
          </p>
        </div>
        <div class="pill pill--count">{{ result.actions|length }} upgrades planned</div>
      </header>
      <div class="summary-grid">
        <div class="stat-card">
          <span class="stat-icon">ðŸ‘‘</span>
          <p class="stat-label">Projected King</p>
          <p class="stat-value">{{ result.final_profile.king_level }}</p>
          <p class="stat-hint">+{{ "{:,}".format(result.final_profile.xp_into_level) }} XP</p>
        </div>
        <div class="stat-card">
          <span class="stat-icon">âœ¨</span>
          <p class="stat-label">Total XP</p>
          <p class="stat-value">{{ "{:,}".format(result.total_xp_gained) }}</p>
        </div>
        <div class="stat-card">
          <span class="stat-icon">ðŸŸ¡</span>
          <p class="stat-label">Gold Spent</p>
          <p class="stat-value">{{ "{:,}".format(result.total_gold_spent) }}</p>
        </div>
        <div class="stat-card">
          <span class="stat-icon">ðŸ’Ž</span>
          <p class="stat-label">Gems Spent</p>
          <p class="stat-value">{{ "{:,}".format(result.total_gems_used) }}</p>
        </div>
      </div>

      {% if result.actions %}
      <div class="table-wrapper">
        <table>
          <thead>
            <tr>
              <th>Card</th>
              <th>Rarity</th>
              <th>From â†’ To</th>
              <th>Gold</th>
              <th>Cards</th>
              <th>Wild</th>
              <th>Gems</th>
              <th>XP</th>
              <th>Cost/XP</th>
            </tr>
          </thead>
          <tbody>
            {% for action in result.actions %}
            <tr class="row-{{ action.rarity|lower }}">
              <td>{{ action.card_name }}</td>
              <td><span class="rarity-badge badge-{{ action.rarity|lower }}">{{ action.rarity }}</span></td>
              <td>{{ action.from_level }} â†’ {{ action.to_level }}</td>
              <td>{{ "{:,}".format(action.gold_cost) }}</td>
              <td>{{ "{:,}".format(action.card_cost) }}</td>
              <td>{{ "{:,}".format(action.wild_cards_used) }}</td>
              <td>{{ "{:,}".format(action.gems_used) }}</td>
              <td>{{ "{:,}".format(action.xp_gained) }}</td>
              <td class="{% if action.efficiency_ratio < 10 %}efficiency-good{% endif %}">{{ "{:.2f}".format(action.efficiency_ratio) }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% else %}
      <p class="empty">No upgrades available for this configuration. {% if mode == 'min_cost' %}You may already be at the target king level!{% endif %}</p>
      {% endif %}
    </section>
    {% endif %}
  </main>

  <script>
    // Mode tab switching
    document.querySelectorAll('.mode-tab').forEach(tab => {
      tab.addEventListener('click', function() {
        const mode = this.dataset.mode;
        
        // Update active tab
        document.querySelectorAll('.mode-tab').forEach(t => t.classList.remove('active'));
        this.classList.add('active');
        
        // Update hidden input
        document.getElementById('mode-input').value = mode;
        
        // Toggle descriptions
        document.querySelectorAll('.mode-description').forEach(desc => desc.style.display = 'none');
        document.getElementById('desc-' + mode).style.display = 'block';
        
        // Toggle target level section
        const targetSection = document.getElementById('target-level-section');
        if (mode === 'min_cost') {
          targetSection.style.display = 'block';
        } else {
          targetSection.style.display = 'none';
        }
        
        // Toggle button text
        document.querySelectorAll('[id^="btn-text-"]').forEach(span => span.style.display = 'none');
        document.getElementById('btn-text-' + mode).style.display = 'inline';
      });
    });
  </script>
</body>
</html>