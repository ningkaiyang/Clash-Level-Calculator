<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Clash Level Calculator</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800;900&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>
<body>
  <main class="page">
    <header class="hero">
      <div>
        <p class="eyebrow">Clash Royale Â· Level 16 Update</p>
        <h1>Level-up planner, now on the web. <span aria-hidden="true">ðŸ‘‘</span></h1>
        <p class="lede">Run the optimizer with your own data or fetch a live snapshot from RoyaleAPI. Allow gems optionally and get a gold-first, blue-royal plan for maximum XP.</p>
      </div>
      <div class="pill">Powered by Flask Â· Render-ready</div>
    </header>

    {% if errors %}
    <section class="panel error">
      <h2>Something went wrong</h2>
      <ul>
        {% for error in errors %}
          <li>{{ error }}</li>
        {% endfor %}
      </ul>
    </section>
    {% endif %}

    <section class="panel">
      <form method="POST" class="form-grid">
        <div class="card">
          <div class="card-header">
            <h2>Fetch player snapshot</h2>
            <p class="hint">RoyaleAPI lookup requires <code>ROYALE_API_KEY</code> set on the server.</p>
          </div>
          <label class="field">
            <span>Player tag</span>
            <input type="text" name="player_tag" placeholder="#G2VV9802" value="{{ player_tag }}" autocomplete="off">
          </label>
          <div class="field-row">
            <label class="field">
              <span>Available gold</span>
              <input type="text" name="gold" placeholder="450000" value="{{ gold_input }}">
            </label>
            <label class="field">
              <span>Available gems</span>
              <input type="text" name="gems" placeholder="800" value="{{ gems_input }}">
            </label>
          </div>
          <div class="wild-grid">
            <label class="field-label">Wild Cards</label>
            <div class="wild-grid__inputs">
              <label class="field">
                <span>Common</span>
                <input type="text" name="wild_common" placeholder="0" value="{{ wild_cards_input.common }}">
              </label>
              <label class="field">
                <span>Rare</span>
                <input type="text" name="wild_rare" placeholder="0" value="{{ wild_cards_input.rare }}">
              </label>
              <label class="field">
                <span>Epic</span>
                <input type="text" name="wild_epic" placeholder="0" value="{{ wild_cards_input.epic }}">
              </label>
              <label class="field">
                <span>Legendary</span>
                <input type="text" name="wild_legendary" placeholder="0" value="{{ wild_cards_input.legendary }}">
              </label>
              <label class="field">
                <span>Champion</span>
                <input type="text" name="wild_champion" placeholder="0" value="{{ wild_cards_input.champion }}">
              </label>
            </div>
          </div>
          <div class="actions">
            <button type="submit" class="btn-clash">Fetch + optimize</button>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <h2>Optimizer settings</h2>
            <p class="hint">Toggle how aggressive the plan should be.</p>
          </div>
          <label class="checkbox">
            <input type="checkbox" name="use_gems" {% if settings.use_gems %}checked{% endif %}>
            <span>Allow spending gems for missing cards</span>
          </label>
          <label class="checkbox">
            <input type="checkbox" name="infinite_gold" {% if settings.infinite_gold %}checked{% endif %}>
            <span>Ignore gold limits (card bottleneck mode)</span>
          </label>
        </div>
      </form>
    </section>

    {% if result %}
    <section class="panel results">
      <header class="results-header">
        <div>
          <h2>Plan summary</h2>
          <p class="hint">Based on the options you selected above.</p>
        </div>
        <div class="pill pill--count">{{ result.actions|length }} upgrades planned</div>
      </header>
      <div class="summary-grid">
        <div class="stat-card">
          <span class="stat-icon">ðŸ‘‘</span>
          <p class="stat-label">Projected King</p>
          <p class="stat-value">{{ result.final_profile.king_level }}</p>
          <p class="stat-hint">+{{ "{:,}".format(result.final_profile.xp_into_level) }} XP</p>
        </div>
        <div class="stat-card">
          <span class="stat-icon">âœ¨</span>
          <p class="stat-label">Total XP</p>
          <p class="stat-value">{{ "{:,}".format(result.total_xp_gained) }}</p>
        </div>
        <div class="stat-card">
          <span class="stat-icon">ðŸŸ¡</span>
          <p class="stat-label">Gold Spent</p>
          <p class="stat-value">{{ "{:,}".format(result.total_gold_spent) }}</p>
        </div>
        <div class="stat-card">
          <span class="stat-icon">ðŸ’Ž</span>
          <p class="stat-label">Gems Spent</p>
          <p class="stat-value">{{ "{:,}".format(result.total_gems_used) }}</p>
        </div>
      </div>

      {% if result.actions %}
      <div class="table-wrapper">
        <table>
          <thead>
            <tr>
              <th>Card</th>
              <th>Rarity</th>
              <th>From â†’ To</th>
              <th>Gold</th>
              <th>Cards</th>
              <th>Wild</th>
              <th>Gems</th>
              <th>XP</th>
              <th>Gold/XP</th>
            </tr>
          </thead>
          <tbody>
            {% for action in result.actions %}
            <tr class="row-{{ action.rarity|lower }}">
              <td>{{ action.card_name }}</td>
              <td><span class="rarity-badge badge-{{ action.rarity|lower }}">{{ action.rarity }}</span></td>
              <td>{{ action.from_level }} â†’ {{ action.to_level }}</td>
              <td>{{ "{:,}".format(action.gold_cost) }}</td>
              <td>{{ "{:,}".format(action.card_cost) }}</td>
              <td>{{ "{:,}".format(action.wild_cards_used) }}</td>
              <td>{{ "{:,}".format(action.gems_used) }}</td>
              <td>{{ "{:,}".format(action.xp_gained) }}</td>
              <td class="{% if action.efficiency_ratio < 10 %}efficiency-good{% endif %}">{{ "{:.2f}".format(action.efficiency_ratio) }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% else %}
      <p class="empty">No upgrades available for this configuration.</p>
      {% endif %}
    </section>
    {% endif %}
  </main>
</body>
</html>